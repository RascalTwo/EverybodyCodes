import { describe, expect, test } from 'vitest'


// A utility function to find the vertex with 
// minimum key value, from the set of vertices 
// not yet included in MST 
function minKey(key, mstSet, V) {
	// Initialize min value 
	let min = Number.MAX_VALUE, min_index = -1;

	for (let v = 0; v < V; v++)
		if (!mstSet[v] && key[v] < min) {
			min = key[v];
			min_index = v;
		}

	return min_index;
}

// A utility function to print the 
// constructed MST stored in parent[] 
function printMST(parent: number[], graph: number[][]) {
	const vs = []
	for (let i = 1; i < graph.length; i++) {
		vs.push(graph[i][parent[i]])
	}
	return vs
}

// Function to construct and print MST for 
// a graph represented using adjacency matrix 
function primMST(graph: number[][]) {
	// Array to store constructed MST 
	let parent = new Array(graph.length);

	// Key values used to pick minimum weight edge in cut 
	let key = new Array(graph.length);

	// To represent set of vertices included in MST 
	let mstSet = new Array(graph.length);

	// Initialize all keys as INFINITE 
	for (let i = 0; i < graph.length; i++) {
		key[i] = Number.MAX_VALUE;
		mstSet[i] = false;
	}

	// Always include first vertex in MST. 
	key[0] = 0;
	parent[0] = -1; // First node is always root of MST 

	// The MST will have V vertices 
	for (let count = 0; count < graph.length - 1; count++) {
		// Pick the minimum key vertex from the set of vertices not yet included in MST 
		let u = minKey(key, mstSet, graph.length);

		// Add the picked vertex to the MST Set 
		mstSet[u] = true;

		// Update key value and parent index of the adjacent vertices of the picked vertex. 
		for (let v = 0; v < graph.length; v++) {
			// graph[u][v] is non-zero only for adjacent vertices of u 
			// mstSet[v] is false for vertices not yet included in MST 
			// Update the key only if graph[u][v] is smaller than key[v] 
			if (graph[u][v] && !mstSet[v] && graph[u][v] < key[v]) {
				parent[v] = u;
				key[v] = graph[u][v];
			}
		}
	}

	// Print the constructed MST 
	return printMST(parent, graph);
}


type Star = { id: number, r: number, c: number }

const parseStars = (notes: string): Star[] => {
	const world = notes.split('\n').map(l => [...l])
	const stars = [];
	for (let r = 0; r < world.length; r++) {
		for (let c = 0; c < world[0].length; c++) {
			if (world[r][c] === '*') {
				stars.push({ id: stars.length + 1, r, c })
			}
		}
	}
	return stars
}

function distanceBetween(from: Star, to: Star) {
	return Math.abs(from.r - to.r) + Math.abs(from.c - to.c)
}

const getConstellations = (stars: Star[], constellationDistances: number) => {
	const constellations = []
	for (const from of stars) {
		let existingConst = constellations.find(c => c.some(star => distanceBetween(from, star) < constellationDistances))
		if (!existingConst) {
			existingConst = []
			constellations.push(existingConst)
		}
		existingConst.push(from)
	}

	for (let c1 = constellations.length - 1; c1 >= 1; c1--) {
		for (let c2 = c1 - 1; c2 >= 0; c2--) {
			if (c1 === c2) continue
			if (constellations[c1].some(c1s => constellations[c2].some(c2s => distanceBetween(c1s, c2s) < constellationDistances))) {
				constellations[c2].push(...constellations[c1])
				constellations.splice(c1, 1)
				break
			}
		}
	}

	return constellations
}

const getConstellationSizes = (notes: string, constellationDistances: number = 6) =>
	getConstellations(parseStars(notes), constellationDistances).map(constellation => {
		const adgGraph: number[][] = [];
		for (const from of constellation) {
			adgGraph.push(constellation.map(to => distanceBetween(from, to)))
		}

		return primMST(adgGraph).reduce((a, b) => a + b, 0) + adgGraph.length
	}).sort((a, b) => b - a)


function solveQuest(notes: string) {
	return getConstellationSizes(notes, Number.MAX_SAFE_INTEGER)[0]
}

function solveQuest3(notes: string) {
	return getConstellationSizes(notes, 6).slice(0, 3).reduce((a, b) => a * b, 1)
}

describe('Part 1', () => {
	test('Example', () => {
		expect(solveQuest(`*...*
..*..
.....
.....
*.*..`)).toBe(16)
	})

	test('Notes', () => {
		expect(solveQuest(`*.........*.........*
.....................
.....*...*........*..
.....................
....*.....*...*......
.....................
........*...*........
.....................
*.....*...*...*.....*
.....................
........*...*........
.....................
.......*....*.....*..
.....................
...*...*...*.........
.....................
*.........*.........*`)).toBe(135)
	})
})

describe('Part 2', () => {
	test('Notes', () => {
		expect(solveQuest(`*...........................*..*....................*...............................................*
...........*...................................................*.....................................
................*.....................................*......*.*...................*.............*...
........................................................................*............................
.........*.....*.....*.......*....................................................*..................
.......*......*.......*......*..........................................*.................*..........
..*.*............*..................*.........................................*......................
.................................................*.*..........................................*......
....*.............................*.*..........*........................*....................*.....*.
..............*............*...................................................*....................*
............................................................*..........................*.....*.......
...*..*....................*.....*..............................................................*....
..............*....................*......................*........................*.................
..........*......................................*..............*.....................*..........*...
.........*...............................................*.......*..........*......*.................
...........*...*..........*................*.........................................*...*...........
.......................................................................*..*.....................*....
............................................................*...*...*................................
........*...**.....................*......................*..........................................
.............................................................................*.......................
.....................*..*................*........*................*.................*...............
...*............................*.....*........*.....................................................
...................*.....*.....**.....................................**.....................*.......
........*........................................................*...*.*...........................*.
...........................*......................*............*.....*................*...........*..
.......................................*.........***........*...............*..........*.............
....*........*.....*..............................**...............*........*......*.....*...........
...........*..............................*.........*..*.......................................*.....
..........*..............................................*..*...............................*........
.................*.*.............................*.............................**..........*..*......
...............*......*................*....................*......................*....*............
...*............*............................................*....*..............*...................
.............*......*............................................*...................................
..*....................*.............................................................................
.................................*..........*.................................................*......
.................................*..............................*...*..........*............*..*.....
..........*.*.*..........*..........*.....................................*.......................**.
......**..............*...........................................*......*..............*......**....
.......................*...............................................................*..*......*...
...................................*.......*............**...........................................
.....*.................................*..............*..............*...............................
......................................*.*.................**.........*..................*............
.......*........................................................*....................................
.........................................*.............*.*........*...................*..............
......................................................................................*............*.
...................................*.......................*.**......*............*......*...........
............*.............................................*.......*.......*.....*....................
.......................*..............*....................*...............................*.....*...
.........................*..*.*..*.....**................................*...........................
...*.....*..................................................................*................*.....**
*.......*.....*..............................................................*.....................**`)).toBe(1152)
	})
})

describe('Part 3', () => {
	test('Example', () => {
		expect(solveQuest3(`.......................................
..*.......*...*.....*...*......**.**...
....*.................*.......*..*..*..
..*.........*.......*...*.....*.....*..
......................*........*...*...
..*.*.....*...*.....*...*........*.....
.......................................`)).toBe(15624)
	})

	test('Notes', () => {
		expect(solveQuest3(`*..............................................*......................*....*..........*.*.................................................*..............................*.......*................*.....*
..............*.....*........*...........*.....................................*.*.*..*................**..*...................................................................................*.........
...*.....*......................................*........*.............................................*...............................................*............*........................*...........
.*..........*....................................................................................................*..................*......................................*..*.....*.............*......
...........*.............*.............*......*.*.....................*.........*.....*..............*....................................................*.......*...........................*..........
..................................*.....*....................*......*...............................*.......*......*...........................................................*......................**.
.......................................*......*.................*....................................................*...............*.......................**.......................*....*...........*.
....*.............*.....*....*.................*..*.....*........**..................................................*.............................*..*....................................*.....*..*....
.................................*...........................................*..........................................................*....*...................*............................*......*...
....................*...................*.......................................*..............................*..............*..........*.....*....................*....................................
....................*..................................................................................................*.*........................*..................*................*................*.
....................*.........*.......*........*........................**.*..............*.................................*........*...................*........*.......*........*........*............
..............*.....................*.....*........*...............*..................*....................................*...*........*...........*..................................................*.
............................*....*..*......*.**.............*........................................*.........*........*................*.................*......*.*.......*............................
.............................**.*......*...*......**..............*................................*........................*..............*...................................*........*.......*..*.....
..........................*....*..*........***...........................*............................................*.......................*..............*.*......*.**....*...*.......*.......*......
.................................................*.........*..*.....**...........*.....................................................*...*......**.....................................................
.........................*..*...*........*.....*.............*......*..*.......*............................................*..................*...............*........*..*...*......*.......*..........
.....*............*..........*.....*.................*....................*...........*..........................................................................*........**..*......................*...
...................*...*.......*.*.....*..........*............*.........................*....*.........................*..*..............*............*..*......*.....*.*.......*....................*..
.*.........*.............................**..................................*........*...............*......................*...........................................................................
......................*......*....*..*....*.........*.................................*.........*...........................................................**.....*.......*.....**.....*...............*
.......*......................*..........................*................*.................*..............**.**.......................................................**................................
.............*....*.*......**......*..*.....................*....*.................................................*...................................*.............*......*.......*....................
..............*................**...........................................*...................*..................................*......*...**.............*................*...*......*.*.............
...*...............*.*....*.......*...*.............*.....*........................*.................................*.........................................*......*.......*..*...*.....*.............
..............................*.......*............................*......*............................................................*...............*...........................*..*..................
..................*......*......*..........*....................*.....*...*...........................................................................*........*........*.....**......*..................
**..*.........................*.....*.............*...*........*........................*..............................*..........................*.....*...*..................**.............*.........*
.................*...*..*......*..................*........................*..................................*..*.......................................................*...*..*......*.................
........*......................................................................*......................................................................................*........................*....*....
................*......**.....*.................*........*.............*............*....................*............*...........*.......................................*......*......*................
.*........................*........................*......*......................................................*..................*.*.................*........*..............*.......................*
...............*......*.....*..........................................................*.............*..........................*......*.........*..........................*.....*......*...............
.....*......**....................................*.*........*.............*................................*.........................*....*...*....................................*...........*........
..............*.....*......*......................*.*........................................................................................*..**..*........................*......*.....*....*.......*.
........*..........*..........................*..............................*..........................................................................*.....*..............................*..........*
..*..........*.*....*.....*....................**...*..........*........................*.........................**.**..............*......*........*........................*...*.*......*.........*...
.....*.*...............*......................................................*.......*....*...*......*.........*.*......*.....................................*...................*..................*.*
..........*.*...*..*.....*..........*.*.*.....*..............*......................................*............*...........................*....*.*.......**.................*.....*......*............
..........................................................**.....................................................*.......................*..........................................*....................
...........*......*.....*..........*.............................*..*.....................*........................*........................................*............*......*.....*......*...........
...................*..................................................................................................*............*..*..................................................................
........*..*.....*.....*.*..*.......*..........................*......*..............*................*..***....*...............................................................**...*.*.....*...........
..........*.............*...................*.........................................................................................*..............*...................*...........*...................
..........*.....*......**.................*...*..............................................*.........*................*........................................................*......*.....*..*......*
.............*.........................*...............................................................**............................................*........*...................................*......
*........*......*.....*.........*.*...*.........................*.......................................................*.....................................*.*.................*...*.*......*.........
.................*.............*..........*.....*......*.....................................................*.......................*..........................................**.*.......*.............
.........*.....*.....*..............*...............*....................................*..................*............................*.........*....*.........................**.....*.....*........*
.....*...........................................................................*....*...............*........................*..........*..............................*....*..........................
........*....**......*..*......................*......**.............*........*......*.........*........................**...*............*...........................*............*......*...*.*........
........................*...............................................................................**..........*......*................................*............................................
.......**..*.**.....*...................*.......................*.............*.......................*.....*......*............................**.....................*......*..*..*.....*.....*...*....
..................................................*.....................*.................................................................*........*....................*................................
.......*.....*.....*..............................*...............................................*......*.....*.......*.............................................................*.....*.....*......*
......................................................................*...*.........................*.....................................*..................*............**.............*...............
.......*.....*.....*...*....................*..............................................*........*.....*...........................*................*.............................*.....*.....*.......
...............................*...........*............*..........*..........*......................*.............................*.............*......................................*................
*.....*.....*......*...............................................*..*..*..................................................................*..........*....................*........*......*.....*......
.......*......................................*............*......*..............................................*..................................................*......*..........................*..
.*....*.....*.....*.............*...........................*...................*........................................*..........*..................................*.......*.*.*..*.....*.....*......
..............................*.......*..............................................*........................*..........**.....*...........................*..*.........................................
......*.....*.....*.........................................................*............................*.........................................*........*..............*..........*....**.....*......
.........................**.......**..*........................**...................................*.....................*............................*.............**...............................*..
......*.....*.....*..............*......................*..................*..............*..*..........................................*.......*.....................................*.....*.....*......
...................................................................................................*.*.*.*.*.*.*.*.*.....................*...*..............*......*.........................*..........*
.....*.....*.....*...........*.........*.........**..............*............*......*.........*.*.*.*.*.*.*.*.*.*.*.*.......................*.*....................*...............*..*....**.....*.....
.........*.........*..............................*................................*.........*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.........................................................*............*........
.....*.....*.....*.......*.......*..........*.................*..........*..................*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*..............*......*..................*............*......*.....*.....*.*...
.....*....................................*...........*..........*...*.....................*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*......**..................*........*.........................................
.....*.....*....**.......................*......*........*......................................*.*.*.*.*.*.*.*..**...*.*.*.*...................................................*......*.....*...*.*.....
....*....................................*..........*...........*............*.*.*.*.*...........*.*.*.*.*.*.*....*....*.*.*.*......................*.........*.....................*....................
.....*.....*.....*...........*...................*.....*......................*.*.*.*.*.*.*.*.....*.*.*.*.*.*...........*.*.*.*.........*................................*.............*.....*..*..*.....
...................................................*.............................*.*.*.*.*.*.*.....*.*.*.*.*.*.........*.*.*.*......*......*......*...............*......................................
.....*.....**...*.....*.................................................................*.*.*.*.*...*.*.*.*.*.*.*...*.*.*.*.*.*..*..........................*.........................**.....*.....*...*.
........*................................................*.........................................*.*.*.*.*.*.*.*.*.*.*.*.*.*..*......*.............................................*...................
.*...*.....*.....*...*........*......*...........................*........*........*.*.*.*.*.*......*.*.*.*.*.*.*.*.*.*.*.*.*.*................*.......*............*..................*.....*.....*.....
...............................................*...................*..................*.*.*.*.*......*.*.*.*.*.*.*.*.*.*.*.*.*..*............................*..........................................*
.....*.....*.....*............*.*.......*.....*..*...*.......*........................................*.*.*.*.*.*.*.*.*.*.*.*.*....................*.......................*....*......*.....*.....*.....
..................*.....................................................*..............................*.*.*.*.*.*.*.*.*.*.*.*...*.........*.................................................*...........
.*..**.*...*.....*...................*..........*.........................................................*.*.*.*.*.*.*.*.*.*.............................*..........*......*.....*....**....*.....*.....
...........*..................*..........*..............**....................*......*...........*...........*.*.*.*.*.*.*.*....*..........*.........*......*................................*........*..
.....*.....*....**.*...........................*....*....................*............................*...........*.*.*.*.*...........*.*............*.................................**....*.....*.....
.............*.....*..........*.....*...........*....*...............*............................*.....*...............*.....*...............*.*.........*.....................*.....*..................
......*.....*.....*.......*....*..............................*.*......................*..*............................................*.*..............*...*............*..........*.*.*...*....**......
..*.....*.......*...........*............................................................................*................*..*..............................*............*...................*...........
......*.....*.....*..................*.............*.......................................*.................*........................................................................*.....*.....*......
............*..............................*....................................*........*.....................*...............*...........*.............................................................
......*.....*.*...*...*.....................*............*...................*....*........*.*...*....*..............*............*....*.**.....*..............*..........*.*.........*.....*.....**.....
.......*.........*......................................................*...*...................................................*.....*...**........................*....................................
*.....*.....*.*....*......*..................*.........................*.*.......**...............*....................*.....*..*........*...........*.....................**........**.*...*.....*......
..........*....................................................*....................................................*................................*...................*........*.........*............
.......*.....*.....**.............*..*.................*................*..............*.....*...*...*...............*..............................*...........................*....*.....*.....*.......
.*...*.....*..................................................*.*......*.............*........*..................*............*..................*...........*....*...................*....*.............
.......**....*.....*................................*.............................*..............*....................*..........................*................................*..*.*...*.....*.......
..........................................................*..............*.........*................................*.........*..................*.............*.........................................
........**....*.....*...*......................................*.*.....*...*......*..............*.......*.............................**...................**......................*.....*.....*........
....*............................*...........*...............*...........................*..................................*....*..................*.........*..............*..........*.........*......
..*...*.*.....*......*...*.*......................................................................*..*.....................................................................*....*..*......*.....*..*.....
...................................*.................................................................................*.....*......................*...............................................**.....
......**.*.....*.....*...................*.........................*.............................................*...........*..*.................................*................*..*..*.....*.........
........................................*...*..............*.........*...................................................*..........*..*......*.......................*......*..........*................
...**....*......*....**............................*........................................*..........**...............................*.............................*..........**.....*......*..*......
........*...................*.............*....*...............................................................*.....................*..................................*.....*..*.......................
..........*.*...*......*....................*......*..*.....................*...................................*...*.............*...*.....*.........**.....*...................*......*.*...*..........
...*......**...*..................*...............*................*............**....*.*.................*...............*.........*....*..........................*..........*.........................
...........*.....*.....*...........*.*..................*............*.......................*......*..................*.*............*.......*.........................*........*.....*...*.*...........
.....**..........**.......*...*.............*.....................................**................*.........*........*...............*........*...................*................*...................
...........*......*.....*...............................*...............*...............*....*...........*...*.........*..*....*.......*.........*..............................*.....*......*.....*.....
....*.........................*....**...*................*................*....*.......................*..*...................................................*..........................................
........*...*......*...*.*.................*.*...........................................*......*...*.....**...................*.........................**....................**....*......*............
..**.............................................*..............*.**.................*................................*...............*...*..........*...*...............................................
.............*......*.....*.............................*..............*..................................*...............................*.................*.................*.....*......*.............
......*.......*..*...*.....................*................................*...................*...........................*.........*......................*.......*..........*................*..**...
..............*.....*......*.*...............................................................................................................................*...*...........*......*.....*..........*...
.....*....**...................................*......*..........*..................................................*................................*...................................................
...............*......*.....*....*..................*...**.................*....................*............................*....*.......*.................................*.....*...*..*.........*.....
.......*............*..*....................*..............*......*...................................*.....***.................*.................*......*...............................................
.*............*.*......*......*.......*...................*........................................*.................................*.............*........*.............*......*......*................
....*.................*..............................*..*......................................*...........*......*.............*...........................................*...........*........*...*...
..............*..*.....**......*......................*........................................................................................................*.........*......*......*................*
...*.......*.................................*.......................*................................*.*..................................*.......................................*.......*...*.........
.......*..........*......*.....**...........................*................*.....................*...................*.................*..............................*......*......*......*...........
.............................*...........*........*....*.................................*............*.....................*......................................*..*..................................
.................*.*......*.......*.........................................................................*...........*............*......................*.........*....*..*......*...........*.......
........*...........................................................................*.....*...*.......................*......................*..*........***...................*....*.*............*...*.
..........*.........**......*......*...*.*...................*..*..........................*.........*.............*......................................*.........**......*.......*........*.....*..*..
....*...*.*..................*.*...............*........*..........*.*.............................*....**...................*...........*.......................................................*.......
......................*......*.......*..*.*.......*....*.............*..............*........*...*........................................................*.......**......**......*.....................*
.*.....*....*.....*.....................................*..*.........*..........*...........................................................................*............................................
.......................*.......*.......*...........................*....................................*...........................................*............*.*.....*.....*.*....................*..
..........*.................*..................................*...*.......*.....*........*.....*...*..........*...............*..........................*....*....*....................................
.........................*......*........*........................*......................*........................................*............................*........*....*.*..*...............*......
...................................*......................*......................................*......*..........*...............................*.........*............*.....................*........
..........................*.......*......*.*.......*..........................*...........................*.................*.*..............................*........*.......*..........................
....*.............................................................................*................*.............................*..*.......*..............................*.............................
............................*.......*........*.........................*..........*.....................................*..*...............................*..*.....*.......*..............*.............
..*.....................*...*.........*...........*..*.........*....*............................*.............................................................................*..........*......*.....*.
.................*............*...*...*.*....*.*..........*......*.........*................*..........*..........................................*......*........*...*.*.*..............................
........................*.....*.........*...................................*................*........................*..........*..............*................*.......................................
..........................................................................*.*.............*.............*.....*...........*..*..................................*........................................
...........................................**.....................*..............*...............................*................................................................*..*...*...........*...
...................*.*.*...................*......*.............................................*........*.........................*....*........................................................*.......
.............*...........*...............................*....*.*....*.*......*....*........*..........................................*............*................*...*....**.........................
.........*............................*.......*..*....................*.................*.........*.................*.......*..*...........*.*.........................*.................................
............................................*................*........*.......*..*.............................................*....................*.........*...........*........*....................*
....*.............................*............*.......*.*........*........*.*.........................................*..........................................**.....................................
..........................*......................*...........................................................*...........*.*.............................................................................
...........................*....................................................................*...................*............*.......................................*.............................**
*...............................*.......................................*...................*................................................*..........*...*..........................................**`)).toBe(4759326000)
	})
})
