import { describe, expect, test } from 'vitest'


// A utility function to find the vertex with 
// minimum key value, from the set of vertices 
// not yet included in MST 
function minKey(key, mstSet, V) {
	// Initialize min value 
	let min = Number.MAX_VALUE, min_index = -1;

	for (let v = 0; v < V; v++)
		if (!mstSet[v] && key[v] < min) {
			min = key[v];
			min_index = v;
		}

	return min_index;
}

// A utility function to print the 
// constructed MST stored in parent[] 
function printMST(parent: number[], graph: number[][]) {
	//console.log("Edge   Weight");
	const vs = []
	for (let i = 1; i < graph.length; i++) {
		//console.log(parent[i] + " - " + i + "   " + graph[i][parent[i]]);
		vs.push(graph[i][parent[i]])
	}
	return vs
}

// Function to construct and print MST for 
// a graph represented using adjacency matrix 
function primMST(graph: number[][]) {
	// Array to store constructed MST 
	let parent = new Array(graph.length);

	// Key values used to pick minimum weight edge in cut 
	let key = new Array(graph.length);

	// To represent set of vertices included in MST 
	let mstSet = new Array(graph.length);

	// Initialize all keys as INFINITE 
	for (let i = 0; i < graph.length; i++) {
		key[i] = Number.MAX_VALUE;
		mstSet[i] = false;
	}

	// Always include first vertex in MST. 
	key[0] = 0;
	parent[0] = -1; // First node is always root of MST 

	// The MST will have V vertices 
	for (let count = 0; count < graph.length - 1; count++) {
		// Pick the minimum key vertex from the set of vertices not yet included in MST 
		let u = minKey(key, mstSet, graph.length);

		// Add the picked vertex to the MST Set 
		mstSet[u] = true;

		// Update key value and parent index of the adjacent vertices of the picked vertex. 
		for (let v = 0; v < graph.length; v++) {
			// graph[u][v] is non-zero only for adjacent vertices of u 
			// mstSet[v] is false for vertices not yet included in MST 
			// Update the key only if graph[u][v] is smaller than key[v] 
			if (graph[u][v] && !mstSet[v] && graph[u][v] < key[v]) {
				parent[v] = u;
				key[v] = graph[u][v];
			}
		}
	}

	// Print the constructed MST 
	return printMST(parent, graph);
}


function solveQuest(notes: string) {
	const world = notes.split('\n').map(l => [...l])
	const stars = [];
	for (let r = 0; r < world.length; r++) {
		for (let c = 0; c < world[0].length; c++) {
			if (world[r][c] === '*') {
				stars.push({ id: stars.length + 1, r, c })
			}
		}
	}

	function distanceBetween(from, to) {
		return Math.abs(from.r - to.r) + Math.abs(from.c - to.c)
	}

	const graph: Record<string, Record<string, number>> = {}
	for (const from of stars) {
		if (!(from.id in graph)) graph[from.id] = {}
		const fromMap = graph[from.id]

		for (const to of stars) {
			if (from.id === to.id) continue
			fromMap[to.id] = distanceBetween(from, to)
		}
	}

	const adgGraph = [];
	for (const from of stars) {
		const arr = []
		if (!(from.id in graph)) graph[from.id] = {}
		const fromMap = graph[from.id]

		for (const to of stars) {
			arr.push(distanceBetween(from, to))
		}
		adgGraph.push(arr)
	}

	const vs = primMST(adgGraph)
	return vs.reduce((a, b) => a + b, 0) + adgGraph.length
}


function solveQuest3(notes: string) {
	const world = notes.split('\n').map(l => [...l])
	const stars = [];
	for (let r = 0; r < world.length; r++) {
		for (let c = 0; c < world[0].length; c++) {
			if (world[r][c] === '*') {
				stars.push({ id: stars.length + 1, r, c })
			}
		}
	}

	function distanceBetween(from, to) {
		return Math.abs(from.r - to.r) + Math.abs(from.c - to.c)
	}

	const consts = []
	for (const from of stars) {
		let existingConst = consts.find(c => c.stars.some(star => distanceBetween(from, star) < 6))
		if (!existingConst) {
			existingConst = {
				stars: [],
				size: 0,
				graph: {},
				adgGraph: []
			}
			consts.push(existingConst)
		}
		existingConst.stars.push(from)
	}

	for (let c1 = consts.length - 1; c1 >= 1; c1--) {
		for (let c2 = c1 - 1; c2 >= 0; c2--) {
			if (c1 === c2) continue
			// if any c1 stars are within 6 of any c2 starts, merge both
			if (consts[c1].stars.some(c1s => consts[c2].stars.some(c2s => distanceBetween(c1s, c2s) < 6))) {
				consts[c2].stars.push(...consts[c1].stars)
				consts.splice(c1, 1)
				break
			}
		}
	}

	for (const constal of consts) {
		const graph: Record<string, Record<string, number>> = {}
		for (const from of constal.stars) {
			if (!(from.id in graph)) graph[from.id] = {}
			const fromMap = graph[from.id]

			for (const to of constal.stars) {
				if (from.id === to.id) continue
				fromMap[to.id] = distanceBetween(from, to)
			}
		}

		const adgGraph = [];
		for (const from of constal.stars) {
			const arr = []
			if (!(from.id in graph)) graph[from.id] = {}

			for (const to of constal.stars) {
				arr.push(distanceBetween(from, to))
			}
			adgGraph.push(arr)
		}

		constal.graph = graph
		constal.adgGraph = adgGraph
		const vs = primMST(adgGraph)
		const size = vs.reduce((a, b) => a + b, 0) + adgGraph.length
		constal.size = size
	}

	consts.sort((a, b) => b.size - a.size)
	for (const [c, constsal] of consts.entries()) {
		for (const s of constsal.stars) {
			world[s.r][s.c] = String.fromCharCode('A'.charCodeAt(0) + c)
			if (world[s.r][s.c] >= 'Z') world[s.r][s.c] = '*'
		}
	}
	//require('fs').writeFileSync('map.txt', world.map(l => l.join('')).join('\n'))
	return consts.slice(0, 3).reduce((a, b) => a * b.size, 1)
}

describe('Part 1', () => {
	test('Example', () => {
		expect(solveQuest(`*...*
..*..
.....
.....
*.*..`)).toBe(16)
	})

	test('Notes', () => {
		expect(solveQuest(`*.........*.........*
.....................
.....*...*........*..
.....................
....*.....*...*......
.....................
........*...*........
.....................
*.....*...*...*.....*
.....................
........*...*........
.....................
.......*....*.....*..
.....................
...*...*...*.........
.....................
*.........*.........*`)).toBe(135)
	})
})

describe('Part 2', () => {
	test('Notes', () => {
		expect(solveQuest(`*...........................*..*....................*...............................................*
...........*...................................................*.....................................
................*.....................................*......*.*...................*.............*...
........................................................................*............................
.........*.....*.....*.......*....................................................*..................
.......*......*.......*......*..........................................*.................*..........
..*.*............*..................*.........................................*......................
.................................................*.*..........................................*......
....*.............................*.*..........*........................*....................*.....*.
..............*............*...................................................*....................*
............................................................*..........................*.....*.......
...*..*....................*.....*..............................................................*....
..............*....................*......................*........................*.................
..........*......................................*..............*.....................*..........*...
.........*...............................................*.......*..........*......*.................
...........*...*..........*................*.........................................*...*...........
.......................................................................*..*.....................*....
............................................................*...*...*................................
........*...**.....................*......................*..........................................
.............................................................................*.......................
.....................*..*................*........*................*.................*...............
...*............................*.....*........*.....................................................
...................*.....*.....**.....................................**.....................*.......
........*........................................................*...*.*...........................*.
...........................*......................*............*.....*................*...........*..
.......................................*.........***........*...............*..........*.............
....*........*.....*..............................**...............*........*......*.....*...........
...........*..............................*.........*..*.......................................*.....
..........*..............................................*..*...............................*........
.................*.*.............................*.............................**..........*..*......
...............*......*................*....................*......................*....*............
...*............*............................................*....*..............*...................
.............*......*............................................*...................................
..*....................*.............................................................................
.................................*..........*.................................................*......
.................................*..............................*...*..........*............*..*.....
..........*.*.*..........*..........*.....................................*.......................**.
......**..............*...........................................*......*..............*......**....
.......................*...............................................................*..*......*...
...................................*.......*............**...........................................
.....*.................................*..............*..............*...............................
......................................*.*.................**.........*..................*............
.......*........................................................*....................................
.........................................*.............*.*........*...................*..............
......................................................................................*............*.
...................................*.......................*.**......*............*......*...........
............*.............................................*.......*.......*.....*....................
.......................*..............*....................*...............................*.....*...
.........................*..*.*..*.....**................................*...........................
...*.....*..................................................................*................*.....**
*.......*.....*..............................................................*.....................**`)).toBe(1152)
	})
})

describe('Part 3', () => {
	test('Example', () => {
		expect(solveQuest3(`.......................................
..*.......*...*.....*...*......**.**...
....*.................*.......*..*..*..
..*.........*.......*...*.....*.....*..
......................*........*...*...
..*.*.....*...*.....*...*........*.....
.......................................`)).toBe(15624)
	})

	test('Notes', () => {
		expect(solveQuest3(`*..............................................*......................*....*..........*.*.................................................*..............................*.......*................*.....*
..............*.....*........*...........*.....................................*.*.*..*................**..*...................................................................................*.........
...*.....*......................................*........*.............................................*...............................................*............*........................*...........
.*..........*....................................................................................................*..................*......................................*..*.....*.............*......
...........*.............*.............*......*.*.....................*.........*.....*..............*....................................................*.......*...........................*..........
..................................*.....*....................*......*...............................*.......*......*...........................................................*......................**.
.......................................*......*.................*....................................................*...............*.......................**.......................*....*...........*.
....*.............*.....*....*.................*..*.....*........**..................................................*.............................*..*....................................*.....*..*....
.................................*...........................................*..........................................................*....*...................*............................*......*...
....................*...................*.......................................*..............................*..............*..........*.....*....................*....................................
....................*..................................................................................................*.*........................*..................*................*................*.
....................*.........*.......*........*........................**.*..............*.................................*........*...................*........*.......*........*........*............
..............*.....................*.....*........*...............*..................*....................................*...*........*...........*..................................................*.
............................*....*..*......*.**.............*........................................*.........*........*................*.................*......*.*.......*............................
.............................**.*......*...*......**..............*................................*........................*..............*...................................*........*.......*..*.....
..........................*....*..*........***...........................*............................................*.......................*..............*.*......*.**....*...*.......*.......*......
.................................................*.........*..*.....**...........*.....................................................*...*......**.....................................................
.........................*..*...*........*.....*.............*......*..*.......*............................................*..................*...............*........*..*...*......*.......*..........
.....*............*..........*.....*.................*....................*...........*..........................................................................*........**..*......................*...
...................*...*.......*.*.....*..........*............*.........................*....*.........................*..*..............*............*..*......*.....*.*.......*....................*..
.*.........*.............................**..................................*........*...............*......................*...........................................................................
......................*......*....*..*....*.........*.................................*.........*...........................................................**.....*.......*.....**.....*...............*
.......*......................*..........................*................*.................*..............**.**.......................................................**................................
.............*....*.*......**......*..*.....................*....*.................................................*...................................*.............*......*.......*....................
..............*................**...........................................*...................*..................................*......*...**.............*................*...*......*.*.............
...*...............*.*....*.......*...*.............*.....*........................*.................................*.........................................*......*.......*..*...*.....*.............
..............................*.......*............................*......*............................................................*...............*...........................*..*..................
..................*......*......*..........*....................*.....*...*...........................................................................*........*........*.....**......*..................
**..*.........................*.....*.............*...*........*........................*..............................*..........................*.....*...*..................**.............*.........*
.................*...*..*......*..................*........................*..................................*..*.......................................................*...*..*......*.................
........*......................................................................*......................................................................................*........................*....*....
................*......**.....*.................*........*.............*............*....................*............*...........*.......................................*......*......*................
.*........................*........................*......*......................................................*..................*.*.................*........*..............*.......................*
...............*......*.....*..........................................................*.............*..........................*......*.........*..........................*.....*......*...............
.....*......**....................................*.*........*.............*................................*.........................*....*...*....................................*...........*........
..............*.....*......*......................*.*........................................................................................*..**..*........................*......*.....*....*.......*.
........*..........*..........................*..............................*..........................................................................*.....*..............................*..........*
..*..........*.*....*.....*....................**...*..........*........................*.........................**.**..............*......*........*........................*...*.*......*.........*...
.....*.*...............*......................................................*.......*....*...*......*.........*.*......*.....................................*...................*..................*.*
..........*.*...*..*.....*..........*.*.*.....*..............*......................................*............*...........................*....*.*.......**.................*.....*......*............
..........................................................**.....................................................*.......................*..........................................*....................
...........*......*.....*..........*.............................*..*.....................*........................*........................................*............*......*.....*......*...........
...................*..................................................................................................*............*..*..................................................................
........*..*.....*.....*.*..*.......*..........................*......*..............*................*..***....*...............................................................**...*.*.....*...........
..........*.............*...................*.........................................................................................*..............*...................*...........*...................
..........*.....*......**.................*...*..............................................*.........*................*........................................................*......*.....*..*......*
.............*.........................*...............................................................**............................................*........*...................................*......
*........*......*.....*.........*.*...*.........................*.......................................................*.....................................*.*.................*...*.*......*.........
.................*.............*..........*.....*......*.....................................................*.......................*..........................................**.*.......*.............
.........*.....*.....*..............*...............*....................................*..................*............................*.........*....*.........................**.....*.....*........*
.....*...........................................................................*....*...............*........................*..........*..............................*....*..........................
........*....**......*..*......................*......**.............*........*......*.........*........................**...*............*...........................*............*......*...*.*........
........................*...............................................................................**..........*......*................................*............................................
.......**..*.**.....*...................*.......................*.............*.......................*.....*......*............................**.....................*......*..*..*.....*.....*...*....
..................................................*.....................*.................................................................*........*....................*................................
.......*.....*.....*..............................*...............................................*......*.....*.......*.............................................................*.....*.....*......*
......................................................................*...*.........................*.....................................*..................*............**.............*...............
.......*.....*.....*...*....................*..............................................*........*.....*...........................*................*.............................*.....*.....*.......
...............................*...........*............*..........*..........*......................*.............................*.............*......................................*................
*.....*.....*......*...............................................*..*..*..................................................................*..........*....................*........*......*.....*......
.......*......................................*............*......*..............................................*..................................................*......*..........................*..
.*....*.....*.....*.............*...........................*...................*........................................*..........*..................................*.......*.*.*..*.....*.....*......
..............................*.......*..............................................*........................*..........**.....*...........................*..*.........................................
......*.....*.....*.........................................................*............................*.........................................*........*..............*..........*....**.....*......
.........................**.......**..*........................**...................................*.....................*............................*.............**...............................*..
......*.....*.....*..............*......................*..................*..............*..*..........................................*.......*.....................................*.....*.....*......
...................................................................................................*.*.*.*.*.*.*.*.*.....................*...*..............*......*.........................*..........*
.....*.....*.....*...........*.........*.........**..............*............*......*.........*.*.*.*.*.*.*.*.*.*.*.*.......................*.*....................*...............*..*....**.....*.....
.........*.........*..............................*................................*.........*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.........................................................*............*........
.....*.....*.....*.......*.......*..........*.................*..........*..................*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*..............*......*..................*............*......*.....*.....*.*...
.....*....................................*...........*..........*...*.....................*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*......**..................*........*.........................................
.....*.....*....**.......................*......*........*......................................*.*.*.*.*.*.*.*..**...*.*.*.*...................................................*......*.....*...*.*.....
....*....................................*..........*...........*............*.*.*.*.*...........*.*.*.*.*.*.*....*....*.*.*.*......................*.........*.....................*....................
.....*.....*.....*...........*...................*.....*......................*.*.*.*.*.*.*.*.....*.*.*.*.*.*...........*.*.*.*.........*................................*.............*.....*..*..*.....
...................................................*.............................*.*.*.*.*.*.*.....*.*.*.*.*.*.........*.*.*.*......*......*......*...............*......................................
.....*.....**...*.....*.................................................................*.*.*.*.*...*.*.*.*.*.*.*...*.*.*.*.*.*..*..........................*.........................**.....*.....*...*.
........*................................................*.........................................*.*.*.*.*.*.*.*.*.*.*.*.*.*..*......*.............................................*...................
.*...*.....*.....*...*........*......*...........................*........*........*.*.*.*.*.*......*.*.*.*.*.*.*.*.*.*.*.*.*.*................*.......*............*..................*.....*.....*.....
...............................................*...................*..................*.*.*.*.*......*.*.*.*.*.*.*.*.*.*.*.*.*..*............................*..........................................*
.....*.....*.....*............*.*.......*.....*..*...*.......*........................................*.*.*.*.*.*.*.*.*.*.*.*.*....................*.......................*....*......*.....*.....*.....
..................*.....................................................*..............................*.*.*.*.*.*.*.*.*.*.*.*...*.........*.................................................*...........
.*..**.*...*.....*...................*..........*.........................................................*.*.*.*.*.*.*.*.*.*.............................*..........*......*.....*....**....*.....*.....
...........*..................*..........*..............**....................*......*...........*...........*.*.*.*.*.*.*.*....*..........*.........*......*................................*........*..
.....*.....*....**.*...........................*....*....................*............................*...........*.*.*.*.*...........*.*............*.................................**....*.....*.....
.............*.....*..........*.....*...........*....*...............*............................*.....*...............*.....*...............*.*.........*.....................*.....*..................
......*.....*.....*.......*....*..............................*.*......................*..*............................................*.*..............*...*............*..........*.*.*...*....**......
..*.....*.......*...........*............................................................................*................*..*..............................*............*...................*...........
......*.....*.....*..................*.............*.......................................*.................*........................................................................*.....*.....*......
............*..............................*....................................*........*.....................*...............*...........*.............................................................
......*.....*.*...*...*.....................*............*...................*....*........*.*...*....*..............*............*....*.**.....*..............*..........*.*.........*.....*.....**.....
.......*.........*......................................................*...*...................................................*.....*...**........................*....................................
*.....*.....*.*....*......*..................*.........................*.*.......**...............*....................*.....*..*........*...........*.....................**........**.*...*.....*......
..........*....................................................*....................................................*................................*...................*........*.........*............
.......*.....*.....**.............*..*.................*................*..............*.....*...*...*...............*..............................*...........................*....*.....*.....*.......
.*...*.....*..................................................*.*......*.............*........*..................*............*..................*...........*....*...................*....*.............
.......**....*.....*................................*.............................*..............*....................*..........................*................................*..*.*...*.....*.......
..........................................................*..............*.........*................................*.........*..................*.............*.........................................
........**....*.....*...*......................................*.*.....*...*......*..............*.......*.............................**...................**......................*.....*.....*........
....*............................*...........*...............*...........................*..................................*....*..................*.........*..............*..........*.........*......
..*...*.*.....*......*...*.*......................................................................*..*.....................................................................*....*..*......*.....*..*.....
...................................*.................................................................................*.....*......................*...............................................**.....
......**.*.....*.....*...................*.........................*.............................................*...........*..*.................................*................*..*..*.....*.........
........................................*...*..............*.........*...................................................*..........*..*......*.......................*......*..........*................
...**....*......*....**............................*........................................*..........**...............................*.............................*..........**.....*......*..*......
........*...................*.............*....*...............................................................*.....................*..................................*.....*..*.......................
..........*.*...*......*....................*......*..*.....................*...................................*...*.............*...*.....*.........**.....*...................*......*.*...*..........
...*......**...*..................*...............*................*............**....*.*.................*...............*.........*....*..........................*..........*.........................
...........*.....*.....*...........*.*..................*............*.......................*......*..................*.*............*.......*.........................*........*.....*...*.*...........
.....**..........**.......*...*.............*.....................................**................*.........*........*...............*........*...................*................*...................
...........*......*.....*...............................*...............*...............*....*...........*...*.........*..*....*.......*.........*..............................*.....*......*.....*.....
....*.........................*....**...*................*................*....*.......................*..*...................................................*..........................................
........*...*......*...*.*.................*.*...........................................*......*...*.....**...................*.........................**....................**....*......*............
..**.............................................*..............*.**.................*................................*...............*...*..........*...*...............................................
.............*......*.....*.............................*..............*..................................*...............................*.................*.................*.....*......*.............
......*.......*..*...*.....................*................................*...................*...........................*.........*......................*.......*..........*................*..**...
..............*.....*......*.*...............................................................................................................................*...*...........*......*.....*..........*...
.....*....**...................................*......*..........*..................................................*................................*...................................................
...............*......*.....*....*..................*...**.................*....................*............................*....*.......*.................................*.....*...*..*.........*.....
.......*............*..*....................*..............*......*...................................*.....***.................*.................*......*...............................................
.*............*.*......*......*.......*...................*........................................*.................................*.............*........*.............*......*......*................
....*.................*..............................*..*......................................*...........*......*.............*...........................................*...........*........*...*...
..............*..*.....**......*......................*........................................................................................................*.........*......*......*................*
...*.......*.................................*.......................*................................*.*..................................*.......................................*.......*...*.........
.......*..........*......*.....**...........................*................*.....................*...................*.................*..............................*......*......*......*...........
.............................*...........*........*....*.................................*............*.....................*......................................*..*..................................
.................*.*......*.......*.........................................................................*...........*............*......................*.........*....*..*......*...........*.......
........*...........................................................................*.....*...*.......................*......................*..*........***...................*....*.*............*...*.
..........*.........**......*......*...*.*...................*..*..........................*.........*.............*......................................*.........**......*.......*........*.....*..*..
....*...*.*..................*.*...............*........*..........*.*.............................*....**...................*...........*.......................................................*.......
......................*......*.......*..*.*.......*....*.............*..............*........*...*........................................................*.......**......**......*.....................*
.*.....*....*.....*.....................................*..*.........*..........*...........................................................................*............................................
.......................*.......*.......*...........................*....................................*...........................................*............*.*.....*.....*.*....................*..
..........*.................*..................................*...*.......*.....*........*.....*...*..........*...............*..........................*....*....*....................................
.........................*......*........*........................*......................*........................................*............................*........*....*.*..*...............*......
...................................*......................*......................................*......*..........*...............................*.........*............*.....................*........
..........................*.......*......*.*.......*..........................*...........................*.................*.*..............................*........*.......*..........................
....*.............................................................................*................*.............................*..*.......*..............................*.............................
............................*.......*........*.........................*..........*.....................................*..*...............................*..*.....*.......*..............*.............
..*.....................*...*.........*...........*..*.........*....*............................*.............................................................................*..........*......*.....*.
.................*............*...*...*.*....*.*..........*......*.........*................*..........*..........................................*......*........*...*.*.*..............................
........................*.....*.........*...................................*................*........................*..........*..............*................*.......................................
..........................................................................*.*.............*.............*.....*...........*..*..................................*........................................
...........................................**.....................*..............*...............................*................................................................*..*...*...........*...
...................*.*.*...................*......*.............................................*........*.........................*....*........................................................*.......
.............*...........*...............................*....*.*....*.*......*....*........*..........................................*............*................*...*....**.........................
.........*............................*.......*..*....................*.................*.........*.................*.......*..*...........*.*.........................*.................................
............................................*................*........*.......*..*.............................................*....................*.........*...........*........*....................*
....*.............................*............*.......*.*........*........*.*.........................................*..........................................**.....................................
..........................*......................*...........................................................*...........*.*.............................................................................
...........................*....................................................................*...................*............*.......................................*.............................**
*...............................*.......................................*...................*................................................*..........*...*..........................................**`)).toBe(4759326000)
	})
})
